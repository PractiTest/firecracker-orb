description: >
  This command will get all the configurations for firecracker run
    and execute it.
  Firecracker -is a tool to create testset/test/steps in PractiTest
    from XML test results.
parameters:
  test_folder:
    type: string
    description: "test results folder name"
  firecracker_version:
    type: string
    default: "v2.0.2"
    description: "firecracker version"
  author_id:
    type: string
    description: "firecracker author id"
  extra_params:
    type: string
    default: ""
    description: "firecracker extra parameters"
  api_token:
    type: string
    description: "firecracker api token"
  email:
    type: string
    description: "firecracker email"
  project_id:
    type: string
    description: "firecracker project_id"
  json_extra_params:
    type: string
    default: ""
    description: "firecracker json_extra_params"
  api_uri:
    type: string
    default: "https://prod.practitest.com/"
    description: "firecracker uri"
  multitestset:
    type: boolean
    default: false
    description: "firecracker is multitestset run"
  test_case_as_pt_test_step:
    type: boolean
    default: true
    description: "firecracker is test-case-as-pt-test-step run"
  testset_name:
    type: string
    default: "FirecrackerTestSet"
    description: "firecracker testset name in case of single Testset run"
  additional_test_fields:
    type: string
    default: |
      \"custom-fields\":{},\"system-fields\":{}
    description: "firecracker additional-test-fields"
  additional_testset_fields:
    type: string
    default: |
      \"custom-fields\":{},\"system-fields\":{}
    description: "firecracker additional-testset-fields "

steps:
  - run:
      name: prepare data and download firecracker for
      command: |
        echo "{\"api-token\":\"<<parameters.api_token>>\",\"email\":\"<<parameters.email>>\",\"project-id\":"<<parameters.project_id>>",\"additional-test-fields\":{<<parameters.additional_test_fields>>},\"additional-testset-fields\":{<<parameters.additional_testset_fields>>},\"multitestset\":<<parameters.multitestset>>,\"test-case-as-pt-test-step\":<<parameters.test_case_as_pt_test_step>>,\"testset-name\":<<parameters.testset_name>>}" > config.json
        && wget https://github.com/PractiTest/practitest-firecracker/releases/download/<<parameters.firecracker_version>>/practitest-firecracker-standalone.jar
        && docker create -v /app --name firecracker adoptopenjdk:11-jre-hotspot
        && docker cp "$(pwd)"/<<parameters.test_folder>> firecracker:/app
        && docker cp "$(pwd)"/config.json firecracker:/app
        && docker cp "$(pwd)"/practitest-firecracker-standalone.jar firecracker:/app
      when: always

  - run:
      name: start firecracker
      command: |
        docker run --volumes-from firecracker adoptopenjdk:11-jre-hotspot java --illegal-access=deny -jar /app/practitest-firecracker-standalone.jar --reports-path="app/<<parameters.test_folder>>" --author-id=<<parameters.author_id>> --config-path="app/config.json" <<parameters.extra_params>> create-and-populate-testset
      when: always
